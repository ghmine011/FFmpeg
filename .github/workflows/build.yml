name: FFmpeg Cross-Platform Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly build

env:
  FFMPEG_VERSION: '8.0.1'
  BUILD_FLAGS: '--enable-nonfree --enable-gpl --enable-version3 --disable-doc'

jobs:
  build-linux:
    name: Build on Linux (Ubuntu x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Install dependencies
        run: |
          set -e
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential yasm pkg-config \
            libx264-dev libx265-dev libopus-dev libvorbis-dev \
            libfdk-aac-dev libmp3lame-dev ca-certificates
          echo "âœ“ Dependencies installed"
      
      - name: Configure FFmpeg
        run: |
          set -e
          ./configure \
            --prefix=/usr/local \
            ${{ env.BUILD_FLAGS }} \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libfdk-aac --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log
          [ $? -eq 0 ] && echo "âœ“ Configuration completed" || (tail -50 configure.log && exit 1)
      
      - name: Build & Install
        run: |
          set -e
          make -j$(nproc)
          BUILD_OUTPUT_DIR="${{ github.workspace }}/build-output"
          mkdir -p "${BUILD_OUTPUT_DIR}"
          make install DESTDIR="${BUILD_OUTPUT_DIR}"
          echo "BUILD_OUTPUT_DIR=${BUILD_OUTPUT_DIR}" >> $GITHUB_ENV
      
      - name: Verify installation
        run: |
          set -e
          file_count=$(find "${BUILD_OUTPUT_DIR}" -type f | wc -l)
          echo "âœ“ Installation verified: ${file_count} files"
      
      - name: Create artifact & checksum
        run: |
          set -e
          mkdir -p artifacts
          cd "${BUILD_OUTPUT_DIR}"
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-linux-x86_64.tar.gz" .
          cd "${{ github.workspace }}/artifacts"
          sha256sum ffmpeg-linux-x86_64.tar.gz > ffmpeg-linux-x86_64.tar.gz.sha256
          echo "âœ“ Linux artifact & checksum created"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-x86_64
          path: |
            artifacts/ffmpeg-linux-x86_64.tar.gz
            artifacts/ffmpeg-linux-x86_64.tar.gz.sha256
          retention-days: 30

  build-macos-x86_64:
    name: Build on macOS (x86_64)
    runs-on: macos-latest
    steps:
      # (æ­¥é©Ÿèˆ‡ Linux é¡žä¼¼ï¼Œåƒ…èª¿æ•´ brew å®‰è£èˆ‡æ ¸å¿ƒæ•¸)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Install dependencies
        run: |
          set -e
          brew install -q yasm x264 x265 opus libvorbis fdk-aac lame pkg-config
      
      - name: Configure FFmpeg
        run: |
          set -e
          export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:$PKG_CONFIG_PATH"
          ./configure \
            --prefix=/usr/local \
            ${{ env.BUILD_FLAGS }} \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libfdk-aac --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log
          [ $? -eq 0 ] && echo "âœ“ Configuration completed" || (tail -50 configure.log && exit 1)
      
      - name: Build & Install
        run: |
          set -e
          make -j$(sysctl -n hw.logicalcpu)
          BUILD_OUTPUT_DIR="${{ github.workspace }}/build-output"
          mkdir -p "${BUILD_OUTPUT_DIR}"
          make install DESTDIR="${BUILD_OUTPUT_DIR}"
          echo "BUILD_OUTPUT_DIR=${BUILD_OUTPUT_DIR}" >> $GITHUB_ENV
      
      - name: Create artifact & checksum
        run: |
          set -e
          mkdir -p artifacts
          cd "${BUILD_OUTPUT_DIR}"
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-macos-x86_64.tar.gz" .
          cd "${{ github.workspace }}/artifacts"
          shasum -a 256 ffmpeg-macos-x86_64.tar.gz > ffmpeg-macos-x86_64.tar.gz.sha256
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-x86_64
          path: |
            artifacts/ffmpeg-macos-x86_64.tar.gz
            artifacts/ffmpeg-macos-x86_64.tar.gz.sha256

  build-macos-arm64:
    name: Build on macOS (arm64)
    runs-on: macos-14  # Apple Silicon runner
    steps:
      # å®Œå…¨ç›¸åŒæ–¼ x86_64ï¼Œä½† runner ç‚º macos-14ï¼Œæœƒè‡ªå‹•åµæ¸¬ arm64
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Install dependencies
        run: |
          set -e
          brew install -q yasm x264 x265 opus libvorbis fdk-aac lame pkg-config
      
      - name: Configure FFmpeg
        run: |
          set -e
          export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:$PKG_CONFIG_PATH"
          ./configure \
            --prefix=/usr/local \
            ${{ env.BUILD_FLAGS }} \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libfdk-aac --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log
          [ $? -eq 0 ] && echo "âœ“ Configuration completed" || (tail -50 configure.log && exit 1)
      
      - name: Build & Install
        run: |
          set -e
          make -j$(sysctl -n hw.logicalcpu)
          BUILD_OUTPUT_DIR="${{ github.workspace }}/build-output"
          mkdir -p "${BUILD_OUTPUT_DIR}"
          make install DESTDIR="${BUILD_OUTPUT_DIR}"
          echo "BUILD_OUTPUT_DIR=${BUILD_OUTPUT_DIR}" >> $GITHUB_ENV
      
      - name: Create artifact & checksum
        run: |
          set -e
          mkdir -p artifacts
          cd "${BUILD_OUTPUT_DIR}"
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-macos-arm64.tar.gz" .
          cd "${{ github.workspace }}/artifacts"
          shasum -a 256 ffmpeg-macos-arm64.tar.gz > ffmpeg-macos-arm64.tar.gz.sha256
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-arm64
          path: |
            artifacts/ffmpeg-macos-arm64.tar.gz
            artifacts/ffmpeg-macos-arm64.tar.gz.sha256

  build-windows:
    name: Build on Windows (x86_64 MinGW)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >
            base-devel mingw-w64-x86_64-gcc mingw-w64-x86_64-make
            mingw-w64-x86_64-yasm mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-x264 mingw-w64-x86_64-x265
            mingw-w64-x86_64-opus mingw-w64-x86_64-libvorbis
            mingw-w64-x86_64-lame mingw-w64-x86_64-fdk-aac
      
      - name: Configure FFmpeg
        shell: msys2 {0}
        run: |
          set -e
          ./configure \
            --prefix=/mingw64 \
            ${{ env.BUILD_FLAGS }} \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libfdk-aac --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log
          [ $? -eq 0 ] && echo "âœ“ Configuration completed" || (tail -50 configure.log && exit 1)
      
      - name: Build & Install
        shell: msys2 {0}
        run: |
          set -e
          make -j$(nproc)
          BUILD_OUTPUT_DIR="${{ github.workspace }}/build-output"
          mkdir -p "${BUILD_OUTPUT_DIR}"
          make install DESTDIR="${BUILD_OUTPUT_DIR}"
          echo "BUILD_OUTPUT_DIR=${BUILD_OUTPUT_DIR}" >> $GITHUB_ENV
      
      - name: Create artifact & checksum (tar.gz)
        shell: msys2 {0}
        run: |
          set -e
          mkdir -p "${{ github.workspace }}/artifacts"
          cd "${BUILD_OUTPUT_DIR}"
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-windows-x86_64.tar.gz" .
          cd "${{ github.workspace }}/artifacts"
          sha256sum ffmpeg-windows-x86_64.tar.gz > ffmpeg-windows-x86_64.tar.gz.sha256
          echo "âœ“ Windows artifact & checksum created"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-windows-x86_64
          path: |
            artifacts/ffmpeg-windows-x86_64.tar.gz
            artifacts/ffmpeg-windows-x86_64.tar.gz.sha256

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-macos-x86_64, build-macos-arm64, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release files
        run: |
          set -e
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
          ls -lah release/
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true

  verify-all:
    name: Verify Build Artifacts
    needs: [build-linux, build-macos-x86_64, build-macos-arm64, build-windows]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
      
      - name: Verify artifacts & generate summary
        run: |
          echo "## ðŸ“Š Build Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ–¥ï¸ Platform Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          platforms=(
            "ffmpeg-linux-x86_64/ffmpeg-linux-x86_64.tar.gz"
            "ffmpeg-macos-x86_64/ffmpeg-macos-x86_64.tar.gz"
            "ffmpeg-macos-arm64/ffmpeg-macos-arm64.tar.gz"
            "ffmpeg-windows-x86_64/ffmpeg-windows-x86_64.tar.gz"
          )
          
          for artifact in "${platforms[@]}"; do
            if [ -f "all-artifacts/$artifact" ]; then
              size=$(du -h "all-artifacts/$artifact" | cut -f1)
              echo "- **$(basename $artifact .tar.gz)**: âœ… Found (${size})" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **$(basename $artifact .tar.gz)**: âŒ Missing" >> $GITHUB_STEP_SUMMARY
            fi
          done