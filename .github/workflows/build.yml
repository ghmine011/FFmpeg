name: FFmpeg Cross-Platform Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly build

jobs:
  build-linux:
    name: Build on Linux (x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n8.0.1
          fetch-depth: 1

      - name: Install dependencies (nasm required)
        run: |
          set -e
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential nasm pkg-config \
            libx264-dev libx265-dev libopus-dev libvorbis-dev \
            libfdk-aac-dev libmp3lame-dev ca-certificates

      - name: Configure FFmpeg
        run: |
          set -e
          ./configure \
            --prefix=/usr/local \
            --enable-nonfree --enable-gpl --enable-version3 --disable-doc \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libfdk-aac --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log

      - name: Verify config.mak generated
        run: |
          set -e
          if [ ! -f ffbuild/config.mak ]; then
            echo "âŒ ffbuild/config.mak not generated!"
            tail -100 configure.log
            tail -100 ffbuild/config.log || true
            exit 1
          fi

      - name: Upload configure logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: linux-configure-logs
          path: |
            configure.log
            ffbuild/config.log

      - name: Build & Install
        run: |
          set -e
          make -j$(nproc)
          mkdir -p build-output
          make install DESTDIR="${{ github.workspace }}/build-output"

      - name: Create artifact & checksum
        run: |
          set -e
          mkdir -p artifacts
          cd build-output
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-linux-x86_64.tar.gz" .
          cd "${{ github.workspace }}/artifacts"
          sha256sum ffmpeg-linux-x86_64.tar.gz > ffmpeg-linux-x86_64.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-x86_64
          path: |
            artifacts/ffmpeg-linux-x86_64.tar.gz
            artifacts/ffmpeg-linux-x86_64.tar.gz.sha256

  build-macos-x86_64:
    name: Build on macOS (x86_64)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n8.0.1
          fetch-depth: 1

      - name: Install dependencies (nasm required)
        run: |
          set -e
          brew install nasm x264 x265 opus libvorbis fdk-aac lame pkg-config

      - name: Configure FFmpeg
        run: |
          set -e
          export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:$PKG_CONFIG_PATH"
          ./configure \
            --prefix=/usr/local \
            --enable-nonfree --enable-gpl --enable-version3 --disable-doc \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libfdk-aac --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log

      - name: Verify config.mak generated
        run: |
          set -e
          if [ ! -f ffbuild/config.mak ]; then
            echo "âŒ ffbuild/config.mak not generated!"
            tail -100 configure.log
            tail -100 ffbuild/config.log || true
            exit 1
          fi

      - name: Upload configure logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-configure-logs
          path: |
            configure.log
            ffbuild/config.log

      - name: Build & Install
        run: |
          set -e
          make -j$(sysctl -n hw.logicalcpu)
          mkdir -p build-output
          make install DESTDIR="${{ github.workspace }}/build-output"

      - name: Create artifact & checksum
        run: |
          set -e
          mkdir -p artifacts
          cd build-output
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-macos-x86_64.tar.gz" .
          cd "${{ github.workspace }}/artifacts"
          shasum -a 256 ffmpeg-macos-x86_64.tar.gz > ffmpeg-macos-x86_64.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-x86_64
          path: |
            artifacts/ffmpeg-macos-x86_64.tar.gz
            artifacts/ffmpeg-macos-x86_64.tar.gz.sha256

  build-macos-arm64:
    name: Build on macOS (arm64)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n8.0.1
          fetch-depth: 1

      - name: Install dependencies (nasm required)
        run: |
          set -e
          brew install nasm x264 x265 opus libvorbis fdk-aac lame pkg-config

      - name: Configure FFmpeg
        run: |
          set -e
          export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:$PKG_CONFIG_PATH"
          ./configure \
            --prefix=/usr/local \
            --enable-nonfree --enable-gpl --enable-version3 --disable-doc \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libfdk-aac --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log

      - name: Verify config.mak generated
        run: |
          set -e
          if [ ! -f ffbuild/config.mak ]; then
            echo "âŒ ffbuild/config.mak not generated!"
            tail -100 configure.log
            tail -100 ffbuild/config.log || true
            exit 1
          fi

      - name: Upload configure logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-configure-logs
          path: |
            configure.log
            ffbuild/config.log

      - name: Build & Install
        run: |
          set -e
          make -j$(sysctl -n hw.logicalcpu)
          mkdir -p build-output
          make install DESTDIR="${{ github.workspace }}/build-output"

      - name: Create artifact & checksum
        run: |
          set -e
          mkdir -p artifacts
          cd build-output
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-macos-arm64.tar.gz" .
          cd "${{ github.workspace }}/artifacts"
          shasum -a 256 ffmpeg-macos-arm64.tar.gz > ffmpeg-macos-arm64.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-arm64
          path: |
            artifacts/ffmpeg-macos-arm64.tar.gz
            artifacts/ffmpeg-macos-arm64.tar.gz.sha256

  build-windows:
    name: Build on Windows (x86_64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n8.0.1
          fetch-depth: 1

      - name: Setup MSYS2 (with nasm)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >
            base-devel mingw-w64-x86_64-gcc mingw-w64-x86_64-make
            mingw-w64-x86_64-nasm mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-x264 mingw-w64-x86_64-x265
            mingw-w64-x86_64-opus mingw-w64-x86_64-libvorbis
            mingw-w64-x86_64-lame mingw-w64-x86_64-fdk-aac

      - name: Configure FFmpeg
        shell: msys2 {0}
        run: |
          set -e
          ./configure \
            --prefix=/mingw64 \
            --enable-nonfree --enable-gpl --enable-version3 --disable-doc \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libfdk-aac --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log

      - name: Verify config.mak generated
        shell: msys2 {0}
        run: |
          set -e
          if [ ! -f ffbuild/config.mak ]; then
            echo "âŒ ffbuild/config.mak not generated!"
            tail -100 configure.log
            tail -100 ffbuild/config.log || true
            exit 1
          fi

      - name: Upload configure logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: windows-configure-logs
          path: |
            configure.log
            ffbuild/config.log

      - name: Build & Install
        shell: msys2 {0}
        run: |
          set -e
          make -j$(nproc)
          mkdir -p "${{ github.workspace }}/build-output"
          make install DESTDIR="${{ github.workspace }}/build-output"

      - name: Create artifact & checksum
        shell: msys2 {0}
        run: |
          set -e
          mkdir -p "${{ github.workspace }}/artifacts"
          cd "${{ github.workspace }}/build-output"
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-windows-x86_64.tar.gz" .
          cd "${{ github.workspace }}/artifacts"
          sha256sum ffmpeg-windows-x86_64.tar.gz > ffmpeg-windows-x86_64.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-windows-x86_64
          path: |
            artifacts/ffmpeg-windows-x86_64.tar.gz
            artifacts/ffmpeg-windows-x86_64.tar.gz.sha256

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-macos-x86_64, build-macos-arm64, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          set -e
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
          echo "âœ“ All artifacts prepared for release"
          ls -lah release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  verify-all:
    name: Verify Build Artifacts
    needs: [build-linux, build-macos-x86_64, build-macos-arm64, build-windows]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Generate summary report
        run: |
          echo "## ðŸ“Š Build Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ–¥ï¸ Platform Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          platforms=(
            "ffmpeg-linux-x86_64/ffmpeg-linux-x86_64.tar.gz"
            "ffmpeg-macos-x86_64/ffmpeg-macos-x86_64.tar.gz"
            "ffmpeg-macos-arm64/ffmpeg-macos-arm64.tar.gz"
            "ffmpeg-windows-x86_64/ffmpeg-windows-x86_64.tar.gz"
          )

          for artifact in "${platforms[@]}"; do
            if [ -f "all-artifacts/$artifact" ]; then
              size=$(du -h "all-artifacts/$artifact" | cut -f1)
              echo "- **$(basename $artifact)**: âœ… Found (${size})" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **$(basename $artifact)**: âŒ Missing" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Total Artifacts" >> $GITHUB_STEP_SUMMARY
          if [ -d "all-artifacts" ]; then
            total_files=$(find all-artifacts -type f | wc -l)
            total_size=$(du -sh all-artifacts | cut -f1)
            echo "- **Files**: $total_files" >> $GITHUB_STEP_SUMMARY
            echo "- **Total size**: $total_size" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Files**: 0 âŒ" >> $GITHUB_STEP_SUMMARY
          fi