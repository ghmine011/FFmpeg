name: FFmpeg Cross-Platform Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly build

jobs:
  build-linux:
    name: Build on Linux (x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n8.0.1        # å®˜æ–¹ç©©å®š tag
          fetch-depth: 1

      - name: Install dependencies (including nasm)
        run: |
          set -e
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential nasm pkg-config \
            libx264-dev libx265-dev libopus-dev libvorbis-dev \
            libfdk-aac-dev libmp3lame-dev ca-certificates
          echo "âœ“ Dependencies installed (nasm version: $(nasm -v))"

      - name: Configure FFmpeg
        run: |
          set -e
          ./configure \
            --prefix=/usr/local \
            --enable-nonfree --enable-gpl --enable-version3 --disable-doc \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libfdk-aac --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log
          echo "âœ“ Configuration completed"

      - name: Diagnose configure failure (if any)
        if: failure()
        run: |
          echo "=== configure.log last 100 lines ==="
          tail -100 configure.log
          echo ""
          echo "=== ffbuild/config.log last 100 lines (most important) ==="
          tail -100 ffbuild/config.log || echo "ffbuild/config.log not found"
          exit 1

      - name: Build & Install
        run: |
          set -e
          make -j$(nproc)
          BUILD_OUTPUT_DIR="${{ github.workspace }}/build-output"
          mkdir -p "${BUILD_OUTPUT_DIR}"
          make install DESTDIR="${BUILD_OUTPUT_DIR}"
          echo "BUILD_OUTPUT_DIR=${BUILD_OUTPUT_DIR}" >> $GITHUB_ENV

      - name: Create artifact & checksum
        run: |
          set -e
          mkdir -p artifacts
          cd "${BUILD_OUTPUT_DIR}"
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-linux-x86_64.tar.gz" .
          cd "${{ github.workspace }}/artifacts"
          sha256sum ffmpeg-linux-x86_64.tar.gz > ffmpeg-linux-x86_64.tar.gz.sha256
          echo "âœ“ Artifact created"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-x86_64
          path: |
            artifacts/ffmpeg-linux-x86_64.tar.gz
            artifacts/ffmpeg-linux-x86_64.tar.gz.sha256

  build-macos-x86_64:
    name: Build on macOS (x86_64)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n8.0.1
          fetch-depth: 1

      - name: Install dependencies (including nasm)
        run: |
          set -e
          brew install nasm x264 x265 opus libvorbis fdk-aac lame pkg-config
          echo "âœ“ Dependencies installed (nasm version: $(nasm -v))"

      - name: Configure FFmpeg
        run: |
          set -e
          export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:$PKG_CONFIG_PATH"
          ./configure \
            --prefix=/usr/local \
            --enable-nonfree --enable-gpl --enable-version3 --disable-doc \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libfdk-aac --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log
          echo "âœ“ Configuration completed"

      - name: Diagnose configure failure (if any)
        if: failure()
        run: |
          tail -100 configure.log
          tail -100 ffbuild/config.log || true
          exit 1

      - name: Build & Install
        run: |
          set -e
          make -j$(sysctl -n hw.logicalcpu)
          BUILD_OUTPUT_DIR="${{ github.workspace }}/build-output"
          mkdir -p "${BUILD_OUTPUT_DIR}"
          make install DESTDIR="${BUILD_OUTPUT_DIR}"

      - name: Create artifact & checksum
        run: |
          set -e
          mkdir -p artifacts
          cd "${BUILD_OUTPUT_DIR}"
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-macos-x86_64.tar.gz" .
          cd "${{ github.workspace }}/artifacts"
          shasum -a 256 ffmpeg-macos-x86_64.tar.gz > ffmpeg-macos-x86_64.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-x86_64
          path: |
            artifacts/ffmpeg-macos-x86_64.tar.gz
            artifacts/ffmpeg-macos-x86_64.tar.gz.sha256

  build-macos-arm64:
    name: Build on macOS (arm64)
    runs-on: macos-14
    steps:
      # æ­¥é©Ÿèˆ‡ x86_64 å®Œå…¨ç›¸åŒï¼ˆrunner æœƒè‡ªå‹•ä½¿ç”¨ arm64ï¼‰
      - uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n8.0.1
          fetch-depth: 1

      - name: Install dependencies (including nasm)
        run: |
          set -e
          brew install nasm x264 x265 opus libvorbis fdk-aac lame pkg-config

      - name: Configure FFmpeg
        run: |
          set -e
          export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:$PKG_CONFIG_PATH"
          ./configure \
            --prefix=/usr/local \
            --enable-nonfree --enable-gpl --enable-version3 --disable-doc \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libfdk-aac --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log

      - name: Diagnose configure failure (if any)
        if: failure()
        run: |
          tail -100 configure.log
          tail -100 ffbuild/config.log || true
          exit 1

      - name: Build & Install
        run: |
          set -e
          make -j$(sysctl -n hw.logicalcpu)
          BUILD_OUTPUT_DIR="${{ github.workspace }}/build-output"
          mkdir -p "${BUILD_OUTPUT_DIR}"
          make install DESTDIR="${BUILD_OUTPUT_DIR}"

      - name: Create artifact & checksum
        run: |
          set -e
          mkdir -p artifacts
          cd "${BUILD_OUTPUT_DIR}"
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-macos-arm64.tar.gz" .
          cd "${{ github.workspace }}/artifacts"
          shasum -a 256 ffmpeg-macos-arm64.tar.gz > ffmpeg-macos-arm64.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-arm64
          path: |
            artifacts/ffmpeg-macos-arm64.tar.gz
            artifacts/ffmpeg-macos-arm64.tar.gz.sha256

  build-windows:
    name: Build on Windows (x86_64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n8.0.1
          fetch-depth: 1

      - name: Setup MSYS2 (with nasm)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >
            base-devel mingw-w64-x86_64-gcc mingw-w64-x86_64-make
            mingw-w64-x86_64-nasm mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-x264 mingw-w64-x86_64-x265
            mingw-w64-x86_64-opus mingw-w64-x86_64-libvorbis
            mingw-w64-x86_64-lame mingw-w64-x86_64-fdk-aac

      - name: Configure FFmpeg
        shell: msys2 {0}
        run: |
          set -e
          ./configure \
            --prefix=/mingw64 \
            --enable-nonfree --enable-gpl --enable-version3 --disable-doc \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libfdk-aac --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log
          echo "âœ“ Configuration completed"

      - name: Diagnose configure failure (if any)
        if: failure()
        shell: msys2 {0}
        run: |
          tail -100 configure.log
          tail -100 ffbuild/config.log || true
          exit 1

      - name: Build & Install
        shell: msys2 {0}
        run: |
          set -e
          make -j$(nproc)
          mkdir -p "${{ github.workspace }}/build-output"
          make install DESTDIR="${{ github.workspace }}/build-output"

      - name: Create artifact & checksum
        shell: msys2 {0}
        run: |
          set -e
          mkdir -p "${{ github.workspace }}/artifacts"
          cd "${{ github.workspace }}/build-output"
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-windows-x86_64.tar.gz" .
          cd "${{ github.workspace }}/artifacts"
          sha256sum ffmpeg-windows-x86_64.tar.gz > ffmpeg-windows-x86_64.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-windows-x86_64
          path: |
            artifacts/ffmpeg-windows-x86_64.tar.gz
            artifacts/ffmpeg-windows-x86_64.tar.gz.sha256

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-macos-x86_64, build-macos-arm64, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true

  verify-all:
    name: Verify Build Artifacts
    needs: [build-linux, build-macos-x86_64, build-macos-arm64, build-windows]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: all-artifacts
      - name: Generate summary
        run: |
          echo "## ðŸ“Š Build Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          platforms=(
            "ffmpeg-linux-x86_64/ffmpeg-linux-x86_64.tar.gz"
            "ffmpeg-macos-x86_64/ffmpeg-macos-x86_64.tar.gz"
            "ffmpeg-macos-arm64/ffmpeg-macos-arm64.tar.gz"
            "ffmpeg-windows-x86_64/ffmpeg-windows-x86_64.tar.gz"
          )
          for p in "${platforms[@]}"; do
            if [ -f "all-artifacts/$p" ]; then
              size=$(du -h "all-artifacts/$p" | cut -f1)
              echo "- **$(basename $p)**: âœ… (${size})" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **$(basename $p)**: âŒ Missing" >> $GITHUB_STEP_SUMMARY
            fi
          done