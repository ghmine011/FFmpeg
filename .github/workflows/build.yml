name: FFmpeg Cross-Platform Build (Legal Release)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly build

jobs:
  build-linux:
    name: Build on Linux (x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n8.0.1
          fetch-depth: 1

      - name: Install dependencies
        run: |
          set -e
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential nasm pkg-config \
            libx264-dev libx265-dev libopus-dev libvorbis-dev \
            libmp3lame-dev ca-certificates

      - name: Configure FFmpeg
        run: |
          set -e
          ./configure \
            --prefix=/usr/local \
            --enable-gpl --enable-version3 --disable-doc \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log

      - name: Verify config.mak
        run: |
          set -e
          if [ ! -f ffbuild/config.mak ]; then
            echo "❌ ffbuild/config.mak not generated!"
            tail -100 configure.log
            tail -100 ffbuild/config.log || true
            exit 1
          fi

      - name: Build & Install
        run: |
          set -e
          make -j$(nproc)
          mkdir -p build-output
          make install DESTDIR="${{ github.workspace }}/build-output"

      - name: Package artifact
        run: |
          mkdir -p artifacts
          cd build-output
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-linux-x86_64.tar.gz" usr/local/bin usr/local/lib
          cd "${{ github.workspace }}/artifacts"
          sha256sum ffmpeg-linux-x86_64.tar.gz > ffmpeg-linux-x86_64.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-x86_64
          path: artifacts/*

  build-macos-x86_64:
    name: Build on macOS (x86_64)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n8.0.1
          fetch-depth: 1

      - name: Install dependencies
        run: |
          set -e
          brew install nasm x264 x265 opus libvorbis lame pkg-config

      - name: Configure FFmpeg
        run: |
          set -e
          export MACOSX_DEPLOYMENT_TARGET=11.0
          export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:$(brew --prefix)/opt/*/lib/pkgconfig:$PKG_CONFIG_PATH"
          ./configure \
            --prefix=/usr/local \
            --enable-gpl --enable-version3 --disable-doc \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log

      - name: Build & Install
        run: |
          set -e
          make -j$(sysctl -n hw.logicalcpu)
          mkdir -p build-output
          make install DESTDIR="${{ github.workspace }}/build-output"

      - name: Package artifact
        run: |
          mkdir -p artifacts
          cd build-output
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-macos-x86_64.tar.gz" usr/local/bin usr/local/lib
          cd "${{ github.workspace }}/artifacts"
          shasum -a 256 ffmpeg-macos-x86_64.tar.gz > ffmpeg-macos-x86_64.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-x86_64
          path: artifacts/*

  build-macos-arm64:
    name: Build on macOS (arm64)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n8.0.1
          fetch-depth: 1

      - name: Install dependencies
        run: |
          set -e
          brew install nasm x264 x265 opus libvorbis lame pkg-config

      - name: Configure FFmpeg
        run: |
          set -e
          export MACOSX_DEPLOYMENT_TARGET=11.0
          export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:$(brew --prefix)/opt/*/lib/pkgconfig:$PKG_CONFIG_PATH"
          ./configure \
            --prefix=/usr/local \
            --enable-gpl --enable-version3 --disable-doc \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libmp3lame \
            --enable-shared --disable-stripping \
            2>&1 | tee configure.log

      - name: Build & Install
        run: |
          set -e
          make -j$(sysctl -n hw.logicalcpu)
          mkdir -p build-output
          make install DESTDIR="${{ github.workspace }}/build-output"

      - name: Package artifact
        run: |
          mkdir -p artifacts
          cd build-output
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-macos-arm64.tar.gz" usr/local/bin usr/local/lib
          cd "${{ github.workspace }}/artifacts"
          shasum -a 256 ffmpeg-macos-arm64.tar.gz > ffmpeg-macos-arm64.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-arm64
          path: artifacts/*

  build-windows:
    name: Build on Windows (x86_64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n8.0.1
          fetch-depth: 1

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >
            base-devel mingw-w64-x86_64-gcc mingw-w64-x86_64-make
            mingw-w64-x86_64-nasm mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-x264 mingw-w64-x86_64-x265
            mingw-w64-x86_64-opus mingw-w64-x86_64-libvorbis
            mingw-w64-x86_64-lame

      - name: Configure FFmpeg
        shell: msys2 {0}
        run: |
          set -e
          ./configure \
            --prefix=/mingw64 \
            --enable-gpl --enable-version3 --disable-doc \
            --enable-libx264 --enable-libx265 --enable-libopus \
            --enable-libvorbis --enable-libmp3lame \
            --disable-shared --enable-static --disable-stripping \
            2>&1 | tee configure.log

      - name: Build & Install
        shell: msys2 {0}
        run: |
          set -e
          make -j$(nproc)
          mkdir -p "${{ github.workspace }}/build-output"
          make install DESTDIR="${{ github.workspace }}/build-output"

      - name: Package artifact
        shell: msys2 {0}
        run: |
          mkdir -p "${{ github.workspace }}/artifacts"
          cd "${{ github.workspace }}/build-output/mingw64/bin"
          tar -czf "${{ github.workspace }}/artifacts/ffmpeg-windows-x86_64.tar.gz" *.exe
          cd "${{ github.workspace }}/artifacts"
          sha256sum ffmpeg-windows-x86_64.tar.gz > ffmpeg-windows-x86_64.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-windows-x86_64
          path: artifacts/*

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-macos-x86_64, build-macos-arm64, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
          # 自动生成 LICENSE / BUILDINFO
          echo "FFmpeg build info" > release/BUILDINFO.txt
          cat <<EOF > release/LICENSE.txt
FFmpeg is licensed under GNU General Public License v3 (GPLv3)
Enabled external libraries:
- libx264 (GPL)
- libx265 (GPL)
- libopus (BSD)
- libmp3lame (LGPL)
- libvorbis (BSD)
This build does NOT include any nonfree components.
EOF
          ls -lah release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
